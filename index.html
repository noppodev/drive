<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NoppoDrive 究極完全版 | NoppoStudio</title>
    
    <!-- 外部フレームワーク -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;700;900&family=Space+Grotesk:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">

    <style>
        /* --- 日本語特化型デザインシステム --- */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-soft: #eff6ff;
            --bg-main: #f8fafc;
            --accent: #f59e0b;
            --danger: #ef4444;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif;
            background-color: var(--bg-main);
            color: #1e293b;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .noppo-logo { font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.05em; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* --- アニメーション --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-scale-in { animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* --- カスタムスクロールバー --- */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- UI コンポーネント --- */
        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(241, 245, 249, 1);
        }

        .sidebar {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                box-shadow: 20px 0 50px rgba(0,0,0,0.1);
            }
            .sidebar.open { transform: translateX(0); }
        }

        .item-card {
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            background: white;
            border: 1px solid #f1f5f9;
            position: relative;
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05);
            border-color: var(--primary);
        }
        .item-card.selected {
            background: var(--primary-soft);
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .preview-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 1.25rem;
        }

        /* テキストビューアー修正: はみ出し防止 */
        .text-content-area {
            white-space: pre-wrap;
            word-wrap: break-word;
            word-break: break-all;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .context-menu {
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2);
            animation: pop 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes pop { from { opacity: 0; transform: scale(0.95) translateY(-10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .loader-dots div {
            animation-timing-function: cubic-bezier(0, 1, 1, 0);
        }
        @keyframes loader-dots1 { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes loader-dots2 { 0% { transform: translate(0, 0); } 100% { transform: translate(24px, 0); } }
        @keyframes loader-dots3 { 0% { transform: scale(1); } 100% { transform: scale(0); } }

        [v-cloak] { display: none; }
    </style>
</head>
<body class="select-none text-slate-900">

    <div id="app" v-cloak class="flex h-screen w-full relative">

        <!-- ==========================================
             認証画面 (NoppoAuth)
             ========================================== -->
        <transition name="fade">
            <div v-if="!user" class="fixed inset-0 z-[10000] bg-white flex flex-col items-center justify-center p-6 text-center">
                <div class="absolute inset-0 overflow-hidden pointer-events-none">
                    <div class="absolute -top-24 -left-24 w-96 h-96 bg-blue-50 rounded-full blur-3xl opacity-60"></div>
                    <div class="absolute -bottom-24 -right-24 w-96 h-96 bg-indigo-50 rounded-full blur-3xl opacity-60"></div>
                </div>
                
                <div class="relative z-10 max-w-sm w-full">
                    <div class="w-20 h-20 bg-blue-600 rounded-[2rem] flex items-center justify-center shadow-2xl mb-8 mx-auto animate-bounce">
                        <i data-lucide="cloud" class="w-10 h-10 text-white"></i>
                    </div>
                    <h1 class="noppo-logo text-5xl font-black mb-4 tracking-tighter">NoppoDrive</h1>
                    <p class="text-slate-500 font-medium mb-10">
                        NoppoStudioが贈る、究極の個人用クラウド。<br>全てのデータを、日本語で直感的に管理。
                    </p>
                    <button @click="login" class="w-full bg-slate-900 text-white py-5 rounded-[2rem] font-bold text-lg hover:bg-slate-800 transition-all shadow-xl active:scale-95 flex items-center justify-center gap-3">
                        <span>NoppoAuth でログイン</span>
                        <i data-lucide="arrow-right" class="w-5 h-5"></i>
                    </button>
                    <p class="mt-8 text-[10px] text-slate-400 font-black uppercase tracking-widest">Version 3.0 Ultimate</p>
                </div>
            </div>
        </transition>

        <template v-if="user">
            <!-- モバイルサイドバー用オーバーレイ -->
            <div v-if="isSidebarOpen" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[999] lg:hidden" @click="isSidebarOpen = false"></div>

            <!-- ==========================================
                 サイドバー (日本語ナビ)
                 ========================================== -->
            <aside class="sidebar w-[var(--sidebar-width)] bg-white border-r border-slate-100 flex flex-col shrink-0 overflow-hidden" :class="{ open: isSidebarOpen }">
                <div class="p-8 pb-4">
                    <div class="flex items-center gap-4 mb-10">
                        <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg rotate-3">
                            <i data-lucide="layout-grid" class="w-5 h-5"></i>
                        </div>
                        <h2 class="noppo-logo text-xl font-black tracking-tight">NoppoDrive</h2>
                    </div>

                    <!-- プロフィール -->
                    <div class="flex items-center gap-4 p-4 bg-slate-50 rounded-3xl border border-transparent hover:border-blue-100 transition-all cursor-pointer">
                        <img :src="user.avatar" class="w-10 h-10 rounded-xl object-cover shadow-sm">
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-black truncate text-slate-800">{{ user.userId }}</p>
                            <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">ログイン中</p>
                        </div>
                    </div>
                </div>

                <!-- ナビゲーション -->
                <div class="flex-1 overflow-y-auto p-6 custom-scrollbar space-y-8">
                    <div>
                        <p class="px-4 text-[10px] font-black text-slate-300 uppercase tracking-widest mb-4">マイストレージ</p>
                        <nav class="space-y-1">
                            <button v-for="nav in navItems" :key="nav.id" @click="changeTab(nav.id)"
                                :class="['w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold transition-all relative', currentTab === nav.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-100' : 'text-slate-500 hover:bg-slate-50']">
                                <i :data-lucide="nav.icon" class="w-5 h-5"></i>
                                <span>{{ nav.label }}</span>
                            </button>
                        </nav>
                    </div>

                    <div>
                        <p class="px-4 text-[10px] font-black text-slate-300 uppercase tracking-widest mb-4">ファイル形式</p>
                        <div class="grid grid-cols-1 gap-1">
                            <button v-for="filter in typeFilters" :key="filter.type" @click="activeFilter = filter.type"
                                :class="['flex items-center gap-3 px-5 py-3 rounded-2xl text-xs font-bold transition-all', activeFilter === filter.type ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:bg-slate-50']">
                                <i :data-lucide="filter.icon" class="w-4 h-4"></i>
                                <span>{{ filter.label }}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 容量表示 -->
                <div class="p-8 mt-auto border-t border-slate-50">
                    <div class="mb-6 p-5 bg-blue-50/50 rounded-3xl border border-blue-100">
                        <div class="flex justify-between items-end mb-2">
                            <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">使用容量</p>
                            <span class="text-xs font-black text-blue-700">{{ usagePercent.toFixed(1) }}%</span>
                        </div>
                        <div class="h-2 w-full bg-blue-100 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-600 transition-all duration-1000" :style="{ width: usagePercent + '%' }"></div>
                        </div>
                        <p class="text-[9px] font-bold text-blue-400 mt-2 text-center">{{ usageFormatted }} / 15GB 使用中</p>
                    </div>
                    
                    <button @click="logout" class="w-full flex items-center justify-center gap-3 p-4 text-xs font-black text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-2xl transition-all">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span>ログアウト</span>
                    </button>
                </div>
            </aside>

            <!-- ==========================================
                 メインエリア
                 ========================================== -->
            <main class="flex-1 flex flex-col min-w-0 bg-white relative">
                
                <!-- ヘッダー -->
                <header class="h-24 px-6 lg:px-10 flex items-center justify-between glass-header z-[100]">
                    <div class="flex items-center gap-5">
                        <button @click="isSidebarOpen = true" class="lg:hidden p-3 bg-slate-100 rounded-2xl text-slate-600 hover:bg-slate-200 transition-all">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>
                        
                        <div class="flex items-center gap-3">
                            <button v-if="pathStack.length > 0" @click="popPath" class="p-3 bg-slate-900 text-white rounded-2xl shadow-lg hover:scale-105 active:scale-95 transition-all">
                                <i data-lucide="chevron-left" class="w-5 h-5"></i>
                            </button>
                            <div>
                                <p class="text-[10px] font-black text-slate-300 uppercase tracking-widest mb-0.5">{{ getTabLabel() }}</p>
                                <h2 class="text-xl font-black tracking-tight truncate max-w-[150px] lg:max-w-md">
                                    {{ currentPathName || 'マイドライブ' }}
                                </h2>
                            </div>
                        </div>
                    </div>

                    <!-- アクション -->
                    <div class="flex items-center gap-4">
                        <div class="hidden md:flex relative w-64">
                            <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input v-model="searchQuery" type="text" placeholder="ファイルを検索..." 
                                class="w-full bg-slate-100 border-none rounded-2xl pl-11 pr-4 py-3 text-sm font-bold focus:ring-2 focus:ring-blue-600/10 transition-all outline-none">
                        </div>

                        <!-- アップロードメニュー -->
                        <div class="relative flex items-center gap-2">
                            <!-- フォルダアップロード用 -->
                            <button @click="triggerFolderUpload" class="hidden sm:flex bg-slate-100 text-slate-600 px-5 py-3.5 rounded-2xl font-bold text-sm hover:bg-slate-200 transition-all items-center gap-2">
                                <i data-lucide="folder-up" class="w-5 h-5"></i>
                                <span>フォルダ</span>
                            </button>
                            <button @click="triggerFileUpload" class="bg-blue-600 text-white px-6 py-3.5 rounded-2xl font-bold text-sm shadow-xl shadow-blue-200 hover:bg-blue-700 hover:-translate-y-1 transition-all flex items-center gap-2">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span class="hidden sm:inline">アップロード</span>
                            </button>
                        </div>
                    </div>
                </header>

                <!-- メイングリッド -->
                <div class="flex-1 overflow-y-auto p-6 lg:p-10 custom-scrollbar relative"
                    @dragover.prevent="isDragging = true"
                    @dragleave="isDragging = false"
                    @drop.prevent="onDrop">

                    <!-- ドラッグオーバーレイ -->
                    <transition name="fade">
                        <div v-if="isDragging" class="absolute inset-6 border-4 border-dashed border-blue-400 bg-blue-50/90 backdrop-blur-md rounded-[3rem] z-[500] flex flex-col items-center justify-center text-blue-600 pointer-events-none">
                            <div class="w-24 h-24 bg-white rounded-[2rem] flex items-center justify-center shadow-xl mb-4">
                                <i data-lucide="upload-cloud" class="w-12 h-12 animate-bounce"></i>
                            </div>
                            <p class="text-2xl font-black">ここにドロップして保存</p>
                            <p class="mt-1 font-bold opacity-60">フォルダごとでもOKです</p>
                        </div>
                    </transition>

                    <!-- ツールバー -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-10">
                        <div class="flex items-center gap-2 overflow-x-auto w-full sm:w-auto no-scrollbar pb-2 sm:pb-0">
                            <button @click="viewMode = 'grid'" :class="['p-3 rounded-xl transition-all', viewMode === 'grid' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-400 hover:bg-slate-200']">
                                <i data-lucide="grid" class="w-5 h-5"></i>
                            </button>
                            <button @click="viewMode = 'list'" :class="['p-3 rounded-xl transition-all', viewMode === 'list' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-400 hover:bg-slate-200']">
                                <i data-lucide="list" class="w-5 h-5"></i>
                            </button>
                            <div class="h-6 w-px bg-slate-200 mx-2"></div>
                            <button @click="sortKey = 'name'" :class="['px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all', sortKey === 'name' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-400']">
                                名前順
                            </button>
                            <button @click="sortKey = 'date'" :class="['px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all', sortKey === 'date' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-400']">
                                最新順
                            </button>
                        </div>
                    </div>

                    <!-- コンテンツ表示 -->
                    <div v-if="viewMode === 'grid'" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-8 gap-5 lg:gap-7">
                        
                        <!-- フォルダ新規作成ボタン -->
                        <div @click="createFolder" class="group item-card border-dashed border-2 border-slate-200 bg-slate-50/50 rounded-[2.5rem] p-6 flex flex-col items-center justify-center cursor-pointer hover:border-blue-300 hover:bg-blue-50/30">
                            <div class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform mb-3">
                                <i data-lucide="folder-plus" class="w-6 h-6 text-slate-300 group-hover:text-blue-500"></i>
                            </div>
                            <p class="text-[10px] font-black text-slate-400 group-hover:text-blue-600 tracking-widest">新規フォルダ</p>
                        </div>

                        <!-- アイテムカード -->
                        <div v-for="item in filteredItems" :key="item.id"
                            @click.stop="selectItem(item, $event)"
                            @dblclick="openItem(item)"
                            class="item-card rounded-[2.5rem] p-4 flex flex-col animate-fade-in"
                            :class="{ selected: isSelected(item) }">
                            
                            <!-- 右上メニュー -->
                            <button @click.stop="showContextMenu($event, item)" class="absolute top-3 right-3 p-2 bg-white/80 backdrop-blur rounded-xl text-slate-400 hover:text-blue-600 z-20 shadow-sm border border-slate-50">
                                <i data-lucide="more-vertical" class="w-4 h-4"></i>
                            </button>

                            <div class="aspect-square bg-slate-50 rounded-[2rem] mb-4 flex items-center justify-center relative overflow-hidden group/thumb">
                                <template v-if="item.isFolder">
                                    <i data-lucide="folder" class="w-14 h-14 text-blue-500 fill-blue-500/10"></i>
                                </template>
                                <template v-else>
                                    <img v-if="isImage(item.type)" :src="item.url" class="preview-thumb shadow-inner" loading="lazy">
                                    <div v-else :class="['w-14 h-14 rounded-2xl flex items-center justify-center shadow-sm', getStyle(item.type).bg]">
                                        <i :data-lucide="getStyle(item.type).icon" class="w-7 h-7" :class="getStyle(item.type).text"></i>
                                    </div>
                                </template>

                                <!-- スター -->
                                <div v-if="item.isStarred" class="absolute top-3 left-3 w-7 h-7 bg-amber-400 rounded-full flex items-center justify-center text-white shadow-lg scale-90">
                                    <i data-lucide="star" class="w-3.5 h-3.5 fill-white"></i>
                                </div>
                                
                                <!-- クイックプレビュー (デスクトップ) -->
                                <div class="absolute inset-0 bg-slate-900/40 opacity-0 group-hover/thumb:opacity-100 transition-opacity hidden lg:flex items-center justify-center">
                                    <button @click.stop="openItem(item)" class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-slate-900 hover:scale-110 transition-transform shadow-xl">
                                        <i data-lucide="eye" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="px-1 min-w-0 text-center sm:text-left">
                                <p class="text-xs font-black truncate text-slate-800 mb-0.5">{{ item.name }}</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">
                                    {{ item.isFolder ? 'フォルダ' : formatSize(item.size) }}
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- リスト表示 -->
                    <div v-else class="space-y-2">
                        <div v-for="item in filteredItems" :key="item.id"
                            @click="selectItem(item, $event)"
                            @dblclick="openItem(item)"
                            class="flex items-center gap-4 p-4 bg-white border border-slate-100 rounded-2xl hover:border-blue-400 transition-all cursor-pointer group"
                            :class="{ 'bg-blue-50 border-blue-400': isSelected(item) }">
                            
                            <div :class="['w-12 h-12 rounded-xl flex items-center justify-center shrink-0', item.isFolder ? 'bg-blue-50 text-blue-500' : getStyle(item.type).bg]">
                                <i :data-lucide="item.isFolder ? 'folder' : getStyle(item.type).icon" class="w-6 h-6" :class="!item.isFolder && getStyle(item.type).text"></i>
                            </div>

                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-black text-slate-800 truncate">{{ item.name }}</p>
                                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{{ item.isFolder ? 'フォルダ' : formatSize(item.size) }} • {{ formatDate(item.createdAt) }}</p>
                            </div>

                            <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button @click.stop="handleAction('star', item)" class="p-2" :class="item.isStarred ? 'text-amber-500' : 'text-slate-300 hover:text-amber-500'">
                                    <i data-lucide="star" class="w-5 h-5" :class="{ 'fill-amber-500': item.isStarred }"></i>
                                </button>
                                <button @click.stop="showContextMenu($event, item)" class="p-2 text-slate-400 hover:text-blue-600">
                                    <i data-lucide="more-vertical" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 空の状態 -->
                    <div v-if="!isLoading && filteredItems.length === 0" class="flex flex-col items-center justify-center py-32 text-center">
                        <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6">
                            <i data-lucide="folder-open" class="w-10 h-10 text-slate-200"></i>
                        </div>
                        <h3 class="text-lg font-black text-slate-800 mb-2">ファイルがありません</h3>
                        <p class="text-slate-400 text-xs font-bold">アップロードしてデータを追加しましょう</p>
                    </div>

                    <!-- ロード中 -->
                    <div v-if="isLoading" class="grid grid-cols-2 md:grid-cols-6 gap-6">
                        <div v-for="n in 12" :key="n" class="aspect-square bg-slate-50 animate-pulse rounded-[2rem]"></div>
                    </div>
                </div>

                <!-- 複数選択ツールバー -->
                <transition name="slide-up">
                    <div v-if="selectedItems.length > 0" class="fixed bottom-10 left-1/2 -translate-x-1/2 z-[1000] bg-slate-900 text-white px-8 py-5 rounded-[2.5rem] shadow-2xl flex items-center gap-8 border border-white/10">
                        <div class="flex flex-col">
                            <span class="text-[9px] font-black text-blue-400 uppercase tracking-widest">選択中</span>
                            <span class="text-base font-black">{{ selectedItems.length }} 個のアイテム</span>
                        </div>
                        <div class="h-8 w-px bg-white/10"></div>
                        <div class="flex items-center gap-2">
                            <button @click="bulkAction('star')" class="p-3 hover:bg-white/10 rounded-2xl transition-all" title="お気に入り"><i data-lucide="star" class="w-5 h-5"></i></button>
                            <button @click="bulkAction('delete')" class="px-6 py-3 bg-red-500 hover:bg-red-600 rounded-2xl text-xs font-black transition-all flex items-center gap-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i> 削除
                            </button>
                            <button @click="selectedItems = []" class="p-3 text-slate-400 hover:text-white transition-all"><i data-lucide="x" class="w-5 h-5"></i></button>
                        </div>
                    </div>
                </transition>

                <!-- アップロード進捗 -->
                <transition name="slide-in">
                    <div v-if="uploads.length > 0" class="fixed bottom-10 right-10 z-[1000] w-80 bg-white rounded-[2rem] shadow-2xl border border-slate-100 overflow-hidden animate-scale-in">
                        <div class="p-5 bg-slate-900 text-white flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                <h4 class="text-xs font-black">アップロード中...</h4>
                            </div>
                            <span class="text-[9px] bg-white/20 px-2 py-0.5 rounded-full font-black uppercase">{{ uploads.length }} 個</span>
                        </div>
                        <div class="max-h-60 overflow-y-auto custom-scrollbar p-5 space-y-4">
                            <div v-for="up in uploads" :key="up.id">
                                <div class="flex justify-between items-center text-[10px] mb-1.5">
                                    <span class="font-black text-slate-800 truncate flex-1 mr-2">{{ up.name }}</span>
                                    <span class="font-mono text-blue-600">{{ Math.round(up.progress) }}%</span>
                                </div>
                                <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-600 transition-all duration-300" :style="{ width: up.progress + '%' }"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </transition>
            </main>

            <!-- ==========================================
                 コンテキストメニュー
                 ========================================== -->
            <div v-if="contextMenu.show" :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" 
                class="fixed z-[3000] w-64 bg-white border border-slate-100 rounded-[2rem] p-2 context-menu">
                <div class="px-5 py-3 border-b border-slate-50 mb-1">
                    <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest mb-0.5">ファイル操作</p>
                    <p class="text-xs font-black truncate text-slate-800">{{ contextMenu.item.name }}</p>
                </div>
                <div class="space-y-0.5">
                    <button @click="handleAction('open')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition-all">
                        <i data-lucide="external-link" class="w-4 h-4"></i> 開く
                    </button>
                    <button @click="handleAction('star')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition-all">
                        <i data-lucide="star" class="w-4 h-4" :class="{ 'fill-amber-400 text-amber-400': contextMenu.item.isStarred }"></i> お気に入り
                    </button>
                    <button v-if="!contextMenu.item.isFolder" @click="handleAction('download')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition-all">
                        <i data-lucide="download" class="w-4 h-4"></i> 保存する
                    </button>
                    <button @click="handleAction('rename')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition-all">
                        <i data-lucide="type" class="w-4 h-4"></i> 名前の変更
                    </button>
                    <div class="h-px bg-slate-50 mx-2 my-1"></div>
                    <button @click="handleAction('delete')" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-xs font-bold text-red-500 hover:bg-red-50 transition-all">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> 削除
                    </button>
                </div>
            </div>

            <!-- ==========================================
                 プレビューモーダル (究極版)
                 ========================================== -->
            <transition name="fade">
                <div v-if="preview" class="fixed inset-0 z-[5000] bg-slate-900/90 backdrop-blur-xl flex items-center justify-center p-4 lg:p-10" @click="preview = null">
                    <div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-5xl h-full max-h-[85vh] overflow-hidden flex flex-col relative animate-scale-in" @click.stop>
                        
                        <div class="p-6 lg:p-8 border-b border-slate-50 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 bg-slate-100 rounded-xl flex items-center justify-center">
                                    <i :data-lucide="getStyle(preview.item.type).icon" class="w-5 h-5 text-slate-600"></i>
                                </div>
                                <div class="min-w-0">
                                    <h3 class="font-black text-base text-slate-900 truncate">{{ preview.item.name }}</h3>
                                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">{{ formatSize(preview.item.size) }} • {{ preview.item.type || '不明' }}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button v-if="!preview.item.isFolder" @click="handleAction('download', preview.item)" class="p-3.5 bg-blue-600 text-white rounded-2xl hover:bg-blue-700 shadow-lg transition-all">
                                    <i data-lucide="download" class="w-5 h-5"></i>
                                </button>
                                <button @click="preview = null" class="p-3.5 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-2xl transition-all">
                                    <i data-lucide="x" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>

                        <!-- モーダルコンテンツ -->
                        <div class="flex-1 overflow-auto p-4 lg:p-10 bg-slate-50 flex items-center justify-center custom-scrollbar">
                            <template v-if="isImage(preview.item.type)">
                                <img :src="preview.url" class="max-w-full max-h-full object-contain rounded-2xl shadow-xl">
                            </template>
                            <template v-else-if="preview.item.type.includes('pdf')">
                                <iframe :src="preview.url" class="w-full h-full rounded-xl border-none"></iframe>
                            </template>
                            <!-- テキストビューアー: 折り返し修正済み -->
                            <template v-else-if="isText(preview.item.type)">
                                <div class="w-full h-full bg-white rounded-2xl p-6 lg:p-10 shadow-inner border border-slate-100 overflow-auto">
                                    <pre class="font-mono text-xs lg:text-sm leading-relaxed text-slate-700 text-content-area">{{ preview.text }}</pre>
                                </div>
                            </template>
                            <template v-else>
                                <div class="text-center py-20">
                                    <div class="w-24 h-24 bg-white rounded-[2rem] shadow-lg flex items-center justify-center mx-auto mb-6">
                                        <i data-lucide="file-warning" class="w-10 h-10 text-slate-200"></i>
                                    </div>
                                    <h4 class="text-lg font-black text-slate-800 mb-2">プレビュー対象外の形式</h4>
                                    <p class="text-slate-400 text-xs font-bold max-w-xs mx-auto mb-8">この形式のファイルは直接表示できません。<br>ダウンロードして確認してください。</p>
                                    <button @click="handleAction('download', preview.item)" class="bg-slate-900 text-white px-8 py-3.5 rounded-2xl font-black text-sm shadow-xl hover:scale-105 transition-all">
                                        ダウンロードして開く
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </transition>

            <!-- トースト通知 -->
            <transition name="fade">
                <div v-if="toast" class="fixed top-10 left-1/2 -translate-x-1/2 z-[10000] bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 border border-white/10 animate-fade-in">
                    <div :class="['w-6 h-6 rounded-full flex items-center justify-center', toast.type === 'success' ? 'bg-green-500' : 'bg-red-500']">
                        <i :data-lucide="toast.type === 'success' ? 'check' : 'alert-circle'" class="w-3.5 h-3.5 text-white"></i>
                    </div>
                    <span class="text-xs font-black">{{ toast.message }}</span>
                </div>
            </transition>

            <!-- 隠しインプット -->
            <input type="file" ref="fileInput" class="hidden" multiple @change="onFilesSelected">
            <input type="file" ref="folderInput" class="hidden" webkitdirectory directory multiple @change="onFilesSelected">
        </template>
    </div>

    <!-- ==========================================
         ロジックセクション
         ========================================== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, query, updateDoc, deleteDoc, serverTimestamp, setDoc, getDoc, where } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { createApp, ref, computed, onMounted, nextTick, watch } from "https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwe9BsUFXA4MdzYYuekNsLo320MHqfXww",
            authDomain: "tribal-bonsai-470002-u0.firebaseapp.com",
            projectId: "tribal-bonsai-470002-u0",
            storageBucket: "tribal-bonsai-470002-u0.firebasestorage.app",
            messagingSenderId: "189688737908",
            appId: "1:189688737908:web:f3281eab70669b5796e121"
        };

        const AUTH_WORKER_URL = "https://noppo-auth.noppo5319.workers.dev";
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'noppo-drive-ultimate-plus';
        const CHUNK_SIZE = 800 * 1024; // チャンクサイズ

        createApp({
            setup() {
                // --- 状態 ---
                const user = ref(null);
                const items = ref([]);
                const currentTab = ref('all');
                const activeFilter = ref('all');
                const viewMode = ref('grid');
                const sortKey = ref('date');
                const pathStack = ref([]);
                const searchQuery = ref('');
                const uploads = ref([]);
                const selectedItems = ref([]);
                const contextMenu = ref({ show: false, x: 0, y: 0, item: null });
                const toast = ref(null);
                const preview = ref(null);
                const isDragging = ref(false);
                const isLoading = ref(true);
                const isSidebarOpen = ref(false);
                const fileInput = ref(null);
                const folderInput = ref(null);

                let db, auth;

                // ナビ
                const navItems = [
                    { id: 'all', label: 'マイドライブ', icon: 'hard-drive' },
                    { id: 'starred', label: 'お気に入り', icon: 'star' },
                    { id: 'trash', label: 'ゴミ箱', icon: 'trash-2' }
                ];

                // フィルター
                const typeFilters = [
                    { type: 'all', label: 'すべてのファイル', icon: 'layers' },
                    { type: 'image', label: '画像', icon: 'image' },
                    { type: 'pdf', label: 'ドキュメント', icon: 'file-text' },
                    { type: 'video', label: '動画', icon: 'video' }
                ];

                // --- 算出プロパティ ---
                const currentFolderId = computed(() => pathStack.value.length > 0 ? pathStack.value[pathStack.value.length - 1].id : 'root');
                const currentPathName = computed(() => pathStack.value.length > 0 ? pathStack.value[pathStack.value.length - 1].name : '');

                const filteredItems = computed(() => {
                    let list = items.value.filter(i => {
                        if (currentTab.value === 'trash') return i.isDeleted;
                        if (currentTab.value === 'starred') return !i.isDeleted && i.isStarred;
                        return !i.isDeleted && i.parentId === currentFolderId.value;
                    });

                    if (activeFilter.value !== 'all') {
                        list = list.filter(i => i.type?.includes(activeFilter.value));
                    }

                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        list = list.filter(i => i.name.toLowerCase().includes(q));
                    }

                    return list.sort((a, b) => {
                        if (sortKey.value === 'name') return a.name.localeCompare(b.name);
                        return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                    });
                });

                const totalUsage = computed(() => items.value.reduce((acc, i) => acc + (i.size || 0), 0));
                const usageFormatted = computed(() => (totalUsage.value / (1024 ** 2)).toFixed(1) + " MB");
                const usagePercent = computed(() => Math.min(100, (totalUsage.value / (15 * 1024 ** 3)) * 100));

                // --- メソッド ---
                const refreshIcons = () => nextTick(() => { if (window.lucide) window.lucide.createIcons(); });
                const login = () => window.location.href = `${AUTH_WORKER_URL}?redirect=${encodeURIComponent(window.location.href)}`;
                const logout = () => { 
                    localStorage.removeItem('noppo_user'); 
                    window.location.href = `${AUTH_WORKER_URL}/logout?redirect=${encodeURIComponent(window.location.href)}`; 
                };

                const checkAuth = async () => {
                    const params = new URLSearchParams(window.location.search);
                    const ticket = params.get('ticket');
                    let stored = localStorage.getItem('noppo_user');
                    
                    if (ticket) {
                        try {
                            const res = await fetch(`${AUTH_WORKER_URL}/auth/v1/user?ticket=${ticket}`);
                            if (res.ok) {
                                const d = await res.json();
                                user.value = { userId: d.user_metadata.display_name, avatar: d.user_metadata.avatar_url, uid: d.id };
                                localStorage.setItem('noppo_user', JSON.stringify(user.value));
                                window.history.replaceState({}, '', window.location.pathname);
                            }
                        } catch (e) { console.error("認証エラー:", e); }
                    } else if (stored) {
                        user.value = JSON.parse(stored);
                    }

                    if (user.value) {
                        const fApp = initializeApp(firebaseConfig);
                        db = getFirestore(fApp);
                        auth = getAuth(fApp);
                        await signInAnonymously(auth);
                        syncData();
                    }
                };

                const syncData = () => {
                    const q = query(collection(db, 'artifacts', APP_ID, 'users', user.value.uid, 'items'));
                    onSnapshot(q, (s) => {
                        items.value = s.docs.map(d => ({ id: d.id, ...d.data() }));
                        isLoading.value = false;
                        refreshIcons();
                    });
                };

                // フォルダ構造の再現をサポートするアップロード
                const uploadWithStructure = async (files, parentFolderId) => {
                    const folderMap = { '': parentFolderId }; // パス名 -> Firestore ID

                    // ファイルをパスの深さ順にソート（親フォルダを先に作るため）
                    const sortedFiles = Array.from(files).sort((a, b) => {
                        const aPath = a.webkitRelativePath || '';
                        const bPath = b.webkitRelativePath || '';
                        return aPath.split('/').length - bPath.split('/').length;
                    });

                    for (const file of sortedFiles) {
                        const path = file.webkitRelativePath || '';
                        const parts = path.split('/');
                        let currentParent = parentFolderId;

                        // フォルダが必要なら作成
                        if (parts.length > 1) {
                            let buildPath = '';
                            for (let i = 0; i < parts.length - 1; i++) {
                                const folderName = parts[i];
                                const parentPath = buildPath;
                                buildPath += (buildPath ? '/' : '') + folderName;

                                if (!folderMap[buildPath]) {
                                    // Firestoreにフォルダ作成
                                    const folderDoc = await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.value.uid, 'items'), {
                                        name: folderName, isFolder: true, parentId: folderMap[parentPath] || parentFolderId,
                                        isDeleted: false, isStarred: false, createdAt: serverTimestamp()
                                    });
                                    folderMap[buildPath] = folderDoc.id;
                                }
                                currentParent = folderMap[buildPath];
                            }
                        }

                        // ファイルをアップロード
                        await doUpload(file, currentParent);
                    }
                };

                const doUpload = (file, parentId) => {
                    return new Promise((resolve) => {
                        const uid = Math.random().toString(36).substring(7);
                        uploads.value.push({ id: uid, name: file.name, progress: 0 });
                        
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = async () => {
                            try {
                                const b64 = reader.result;
                                const chunks = [];
                                for (let i = 0; i < b64.length; i += CHUNK_SIZE) chunks.push(b64.substring(i, i + CHUNK_SIZE));

                                const itemDoc = await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.value.uid, 'items'), {
                                    name: file.name, size: file.size, type: file.type, parentId,
                                    isFolder: false, isDeleted: false, isStarred: false,
                                    chunkCount: chunks.length, createdAt: serverTimestamp(), url: b64
                                });

                                for (let i = 0; i < chunks.length; i++) {
                                    await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.value.uid, 'items', itemDoc.id, 'chunks', `c_${i}`), { data: chunks[i] });
                                    const up = uploads.value.find(u => u.id === uid);
                                    if (up) up.progress = ((i + 1) / chunks.length) * 100;
                                }
                                uploads.value = uploads.value.filter(u => u.id !== uid);
                                resolve();
                            } catch (err) {
                                console.error("Upload Error:", err);
                                uploads.value = uploads.value.filter(u => u.id !== uid);
                                resolve();
                            }
                        };
                    });
                };

                const handleAction = async (action, overrideItem = null) => {
                    const item = overrideItem || contextMenu.value.item;
                    if (!item) return;
                    const itemRef = doc(db, 'artifacts', APP_ID, 'users', user.value.uid, 'items', item.id);

                    try {
                        switch(action) {
                            case 'open':
                                if (item.isFolder) { pathStack.value.push({ id: item.id, name: item.name }); currentTab.value = 'all'; }
                                else {
                                    preview.value = { item, url: item.url, text: '読み込み中...' };
                                    if (isText(item.type)) {
                                        try { const res = await fetch(item.url); preview.value.text = await res.text(); }
                                        catch(e) { preview.value.text = '読み込み失敗'; }
                                    }
                                }
                                break;
                            case 'star':
                                await updateDoc(itemRef, { isStarred: !item.isStarred });
                                break;
                            case 'delete':
                                if (currentTab.value === 'trash') {
                                    if(confirm("完全に削除しますか？")) await deleteDoc(itemRef);
                                } else {
                                    await updateDoc(itemRef, { isDeleted: true });
                                    showToast("ゴミ箱に移動しました");
                                }
                                break;
                            case 'rename':
                                const n = prompt("新しい名前:", item.name);
                                if (n && n !== item.name) await updateDoc(itemRef, { name: n });
                                break;
                            case 'download':
                                const a = document.createElement('a'); a.href = item.url; a.download = item.name; a.click();
                                break;
                        }
                    } catch (err) { showToast("操作に失敗しました", "error"); }
                    contextMenu.value.show = false;
                };

                const showContextMenu = (e, item) => {
                    e.preventDefault();
                    contextMenu.value = { show: true, x: Math.min(e.clientX, window.innerWidth - 280), y: Math.min(e.clientY, window.innerHeight - 350), item };
                    const close = () => { contextMenu.value.show = false; document.removeEventListener('click', close); };
                    setTimeout(() => document.addEventListener('click', close), 10);
                };

                const showToast = (m, type = 'success') => {
                    toast.value = { message: m, type };
                    setTimeout(() => toast.value = null, 3000);
                };

                const isText = (t) => ['text/plain', 'application/json', 'text/javascript', 'text/html', 'text/css'].some(x => t?.includes(x));

                onMounted(() => { checkAuth(); refreshIcons(); });
                watch([filteredItems, currentTab, preview, contextMenu, isSidebarOpen], () => refreshIcons());

                return {
                    user, items, currentTab, activeFilter, viewMode, pathStack, searchQuery, uploads, selectedItems, contextMenu, toast, preview, isDragging, isLoading, isSidebarOpen,
                    navItems, typeFilters, currentPathName, filteredItems, usageFormatted, usagePercent, fileInput, folderInput, sortKey,
                    login, logout, changeTab: (id) => { currentTab.value = id; isSidebarOpen.value = false; },
                    triggerFileUpload: () => fileInput.value.click(),
                    triggerFolderUpload: () => folderInput.value.click(),
                    onFilesSelected: (e) => uploadWithStructure(e.target.files, currentFolderId.value),
                    onDrop: (e) => { isDragging.value = false; uploadWithStructure(e.dataTransfer.files, currentFolderId.value); },
                    createFolder: async () => {
                        const n = prompt("フォルダ名を入力:");
                        if (!n) return;
                        await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.value.uid, 'items'), {
                            name: n, isFolder: true, parentId: currentFolderId.value,
                            isDeleted: false, isStarred: false, createdAt: serverTimestamp()
                        });
                    },
                    handleAction, bulkAction: async (a) => { for (const i of selectedItems.value) await handleAction(a, i); selectedItems.value = []; },
                    openItem: (item) => handleAction('open', item), popPath: () => pathStack.value.pop(),
                    getTabLabel: () => navItems.find(n => n.id === currentTab.value)?.label,
                    selectItem: (item, e) => {
                        if (e.ctrlKey || e.metaKey) {
                            const idx = selectedItems.value.findIndex(i => i.id === item.id);
                            if (idx > -1) selectedItems.value.splice(idx, 1);
                            else selectedItems.value.push(item);
                        } else { selectedItems.value = [item]; }
                    },
                    isSelected: (item) => selectedItems.value.some(i => i.id === item.id),
                    showContextMenu, isImage: (t) => t?.startsWith('image/'), isText,
                    formatSize: (b) => b > 1024 * 1024 ? (b / (1024 * 1024)).toFixed(1) + " MB" : (b / 1024).toFixed(1) + " KB",
                    formatDate: (ts) => ts ? new Date(ts.seconds * 1000).toLocaleDateString('ja-JP') : '--',
                    getStyle: (t) => {
                        if (t?.includes('pdf')) return { bg: 'bg-rose-50', text: 'text-rose-500', icon: 'file-text' };
                        if (t?.includes('zip') || t?.includes('archive')) return { bg: 'bg-amber-50', text: 'text-amber-500', icon: 'archive' };
                        if (t?.includes('video')) return { bg: 'bg-indigo-50', text: 'text-indigo-500', icon: 'video' };
                        if (isText(t)) return { bg: 'bg-emerald-50', text: 'text-emerald-500', icon: 'code-xml' };
                        return { bg: 'bg-slate-100', text: 'text-slate-500', icon: 'file' };
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>