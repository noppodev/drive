<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NoppoDrive | NoppoStudio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Noto+Sans+JP:wght@300;400;500;700;900&family=Space+Grotesk:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-glow: rgba(37, 99, 235, 0.4);
            --bg-main: #fcfdfe;
            --sidebar-width: 280px;
        }
        body { 
            font-family: 'Plus Jakarta Sans', 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-main); 
            color: #0f172a; 
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        [v-cloak] { display: none; }
        
        /* Premium Background */
        .bg-orb {
            position: fixed;
            width: 600px;
            height: 600px;
            border-radius: 50%;
            filter: blur(120px);
            z-index: -1;
            opacity: 0.15;
            pointer-events: none;
        }
        .orb-1 { background: #3b82f6; top: -200px; right: -100px; }
        .orb-2 { background: #8b5cf6; bottom: -200px; left: -100px; }

        /* Glassmorphism */
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .dark-glass { background: rgba(10, 15, 30, 0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); }
        
        /* Animations */
        .page-enter { animation: reveal 0.6s cubic-bezier(0.23, 1, 0.32, 1); }
        @keyframes reveal { 
            from { opacity: 0; transform: translateY(15px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }

        .item-card { 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            background: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(226, 232, 240, 0.6);
        }
        .item-card:hover { 
            transform: translateY(-6px); 
            background: #ffffff;
            border-color: var(--primary);
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.05);
        }
        .item-selected { 
            border-color: var(--primary) !important; 
            background: #eff6ff !important; 
            box-shadow: 0 0 0 3px var(--primary-glow); 
        }

        .font-logo { font-family: 'Space Grotesk', sans-serif; letter-spacing: -0.05em; }
        
        /* 修正：スマホ時にサイドバーを物理的に消去 */
        @media (max-width: 1023px) {
            .sidebar-desktop { display: none !important; }
            .mobile-padding { padding-bottom: 140px; } /* スマホメニュー分の余白 */
        }

        .loader {
            width: 24px; height: 24px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .btn-hover { transition: all 0.2s ease; }
        .btn-hover:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-hover:active { transform: translateY(1px); }
    </style>
</head>
<body class="select-none">

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div id="app" v-cloak class="flex h-screen w-full relative">

        <!-- Login / Intro -->
        <div v-if="!user" class="fixed inset-0 z-[2000] bg-white flex flex-col items-center justify-center p-8 text-center">
            <div class="w-24 h-24 bg-blue-600 rounded-[2.8rem] flex items-center justify-center shadow-[0_20px_50px_rgba(37,99,235,0.3)] mb-12 animate-pulse">
                <i data-lucide="cloud" class="w-12 h-12 text-white"></i>
            </div>
            <h1 class="text-5xl font-black mb-4 font-logo text-slate-900">NoppoDrive</h1>
            <p class="text-slate-400 font-medium mb-12 max-w-xs leading-relaxed">Studioクオリティの洗練された<br>次世代クリエイティブストレージ</p>
            <button @click="login" class="w-full max-w-xs py-5 bg-slate-950 text-white rounded-[1.8rem] font-bold btn-hover shadow-2xl flex items-center justify-center gap-3 text-lg">
                <i data-lucide="user" class="w-6 h-6"></i>
                NoppoAuth でログイン
            </button>
        </div>

        <template v-if="user">
            <!-- Sidebar (Desktop Only) -->
            <aside class="sidebar-desktop w-[var(--sidebar-width)] h-full glass border-r border-slate-200/50 flex flex-col z-20">
                <div class="p-8">
                    <div class="flex items-center gap-3 mb-12">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                            <i data-lucide="box" class="w-5 h-5"></i>
                        </div>
                        <span class="font-black text-2xl font-logo">NoppoDrive</span>
                    </div>

                    <button @click="triggerUpload" class="w-full bg-blue-600 text-white py-4 rounded-[1.2rem] font-bold flex items-center justify-center gap-2 btn-hover shadow-xl shadow-blue-100 mb-10">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        新規アップロード
                    </button>

                    <nav class="space-y-2">
                        <button v-for="nav in navItems" :key="nav.id" @click="currentTab = nav.id"
                            :class="['w-full flex items-center gap-4 px-5 py-3.5 rounded-[1.1rem] text-[14px] font-bold transition-all', currentTab === nav.id ? 'bg-slate-900 text-white shadow-xl' : 'text-slate-400 hover:bg-slate-100/50 hover:text-slate-900']">
                            <i :data-lucide="nav.icon" class="w-5 h-5"></i>
                            {{ nav.label }}
                        </button>
                    </nav>
                </div>

                <div class="mt-auto p-8">
                    <div class="bg-white/50 border border-slate-100 p-5 rounded-[1.6rem] mb-6">
                        <div class="flex justify-between text-[10px] font-black text-slate-400 mb-3 uppercase tracking-[0.15em]">
                            <span>Storage Capacity</span>
                            <span :class="storagePercent > 90 ? 'text-rose-500' : ''">{{ storagePercent }}%</span>
                        </div>
                        <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                            <div class="h-full bg-blue-600 rounded-full transition-all duration-1000" :style="{ width: storagePercent + '%' }"></div>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-[1.4rem] shadow-sm">
                        <img :src="user.avatar || 'https://ui-avatars.com/api/?name=' + user.userId" class="w-11 h-11 rounded-[1rem] object-cover bg-slate-200">
                        <div class="flex-1 min-w-0">
                            <p class="text-[13px] font-black text-slate-900 truncate">{{ user.userId }}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Premium Account</p>
                        </div>
                        <button @click="logout" class="p-2 text-slate-300 hover:text-rose-500 transition-colors">
                            <i data-lucide="log-out" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col min-w-0 relative mobile-padding overflow-hidden">
                <header class="h-24 lg:h-32 px-6 lg:px-12 flex items-center justify-between z-10 shrink-0">
                    <div class="flex items-center gap-8 flex-1">
                        <h2 class="hidden lg:block text-3xl font-black text-slate-900 tracking-tighter">{{ currentNavLabel }}</h2>
                        <!-- モバイル用のロゴ表示 -->
                        <div class="lg:hidden flex items-center gap-2">
                            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                                <i data-lucide="box" class="w-4 h-4"></i>
                            </div>
                            <span class="font-black text-xl font-logo">Noppo</span>
                        </div>
                        <div class="flex-1 max-w-xl relative group">
                            <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-300 group-focus-within:text-blue-600 transition-colors"></i>
                            <input v-model="searchQuery" type="text" placeholder="ファイルを検索..." class="w-full bg-white/60 border border-slate-200 focus:border-blue-500 focus:bg-white rounded-[1.4rem] py-4 pl-14 pr-6 text-sm font-semibold outline-none transition-all shadow-sm">
                        </div>
                    </div>
                    
                    <div class="hidden sm:flex items-center gap-4 ml-6">
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button @click="viewMode = 'grid'" :class="['p-2 rounded-lg transition-all', viewMode === 'grid' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400 hover:text-slate-600']">
                                <i data-lucide="layout-grid" class="w-4 h-4"></i>
                            </button>
                            <button @click="viewMode = 'list'" :class="['p-2 rounded-lg transition-all', viewMode === 'list' ? 'bg-white shadow-sm text-blue-600' : 'text-slate-400 hover:text-slate-600']">
                                <i data-lucide="list" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </header>

                <div class="flex-1 overflow-y-auto px-6 lg:px-12 pb-24 custom-scroll">
                    <!-- Loading -->
                    <div v-if="loading" class="flex flex-col items-center justify-center py-48 gap-5">
                        <div class="loader"></div>
                        <p class="text-[10px] font-black text-slate-400 tracking-[0.2em] uppercase">Fetching Files...</p>
                    </div>

                    <!-- Empty State -->
                    <div v-else-if="filteredItems.length === 0" class="flex flex-col items-center justify-center py-40 page-enter">
                        <div class="w-28 h-28 bg-white rounded-[3rem] shadow-xl flex items-center justify-center mb-8 border border-slate-100">
                            <i data-lucide="cloud-off" class="w-12 h-12 text-slate-200"></i>
                        </div>
                        <p class="font-black text-slate-400 text-xl tracking-tight">ここにファイルはありません</p>
                        <button @click="triggerUpload" class="mt-6 text-blue-600 font-bold hover:underline">アップロードを開始する</button>
                    </div>

                    <!-- Grid View -->
                    <div v-else-if="viewMode === 'grid'" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-7 gap-6 lg:gap-8">
                        <div v-for="item in filteredItems" :key="item.id" 
                            @click="handleItemClick(item)"
                            @contextmenu.prevent="showContextMenu($event, item)"
                            :class="['item-card rounded-[2rem] lg:rounded-[2.2rem] p-4 lg:p-5 flex flex-col items-center cursor-pointer page-enter relative group', isSelected(item) ? 'item-selected' : '']">
                            
                            <div class="w-full aspect-[4/3] mb-4 lg:mb-5 flex items-center justify-center overflow-hidden rounded-[1.4rem] bg-slate-50/50 relative border border-slate-100/30">
                                <img v-if="isImage(item.type) && item.url" :src="item.url" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                                <div v-else class="flex flex-col items-center">
                                    <div :class="['w-12 h-12 lg:w-16 lg:h-16 rounded-2xl flex items-center justify-center mb-2 shadow-sm', getStyle(item.type).bg]">
                                        <i :data-lucide="getStyle(item.type).icon" :class="['w-6 h-6 lg:w-8 lg:h-8', getStyle(item.type).text]"></i>
                                    </div>
                                </div>
                                <div v-if="item.processing" class="absolute inset-0 glass flex flex-col items-center justify-center">
                                    <div class="loader scale-75"></div>
                                </div>
                            </div>

                            <div class="w-full text-center px-1">
                                <p class="text-[13px] lg:text-[14px] font-bold text-slate-800 truncate leading-tight">{{ item.name }}</p>
                                <p class="text-[9px] lg:text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1.5">{{ formatSize(item.size) }}</p>
                            </div>

                            <button @click.stop="showContextMenu($event, item)" class="absolute top-3 right-3 lg:top-4 lg:right-4 opacity-0 group-hover:opacity-100 transition-opacity p-2 bg-white rounded-xl shadow-md border border-slate-100 text-slate-400 hover:text-slate-900">
                                <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                            </button>
                            
                            <div v-if="item.is_starred" class="absolute top-4 left-4 lg:top-5 lg:left-5">
                                <i data-lucide="star" class="w-3 h-3 lg:w-4 lg:h-4 text-amber-500 fill-amber-500"></i>
                            </div>
                        </div>
                    </div>

                    <!-- List View -->
                    <div v-else class="space-y-3">
                        <div v-for="item in filteredItems" :key="item.id"
                            @click="handleItemClick(item)"
                            @contextmenu.prevent="showContextMenu($event, item)"
                            :class="['flex items-center px-4 lg:px-6 py-4 rounded-[1.4rem] cursor-pointer border border-transparent transition-all page-enter group', isSelected(item) ? 'item-selected' : 'bg-white/60 hover:bg-white hover:shadow-lg hover:shadow-slate-100']">
                            <div class="flex-1 flex items-center gap-4 lg:gap-5 min-w-0">
                                <div :class="['w-10 h-10 lg:w-11 lg:h-11 rounded-[1rem] flex items-center justify-center shrink-0 shadow-sm', getStyle(item.type).bg]">
                                    <i :data-lucide="getStyle(item.type).icon" :class="['w-4 h-4 lg:w-5 lg:h-5', getStyle(item.type).text]"></i>
                                </div>
                                <div class="min-w-0">
                                    <p class="text-sm font-bold text-slate-900 truncate">{{ item.name }}</p>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase">{{ formatDate(item.createdAt) }}</p>
                                </div>
                                <i v-if="item.is_starred" data-lucide="star" class="w-3.5 h-3.5 text-amber-500 fill-amber-500"></i>
                            </div>
                            <div class="hidden md:block w-32 text-xs font-bold text-slate-400">{{ formatSize(item.size) }}</div>
                            <button @click.stop="showContextMenu($event, item)" class="w-10 flex justify-center text-slate-300 hover:text-slate-900">
                                <i data-lucide="more-vertical" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Floating Mobile Action -->
                <button @click="triggerUpload" class="lg:hidden fixed bottom-32 right-8 w-16 h-16 bg-blue-600 text-white rounded-[1.8rem] flex items-center justify-center shadow-[0_15px_35px_rgba(37,99,235,0.4)] z-30 btn-hover">
                    <i data-lucide="plus" class="w-8 h-8"></i>
                </button>

                <!-- Mobile Nav -->
                <nav class="lg:hidden fixed bottom-8 left-6 right-6 h-20 glass rounded-[2.2rem] border border-slate-200/50 flex items-center justify-around px-4 z-40 shadow-2xl">
                    <button v-for="nav in navItems" :key="nav.id" @click="currentTab = nav.id"
                        :class="['flex flex-col items-center gap-1 transition-all', currentTab === nav.id ? 'text-blue-600 scale-110' : 'text-slate-300']">
                        <i :data-lucide="nav.icon" class="w-6 h-6"></i>
                        <span class="text-[9px] font-black uppercase tracking-widest">{{ nav.label }}</span>
                    </button>
                    <!-- スマホ用のログアウトボタン -->
                    <button @click="logout" class="flex flex-col items-center gap-1 text-slate-300">
                        <i data-lucide="log-out" class="w-6 h-6"></i>
                        <span class="text-[9px] font-black uppercase tracking-widest">Exit</span>
                    </button>
                </nav>
            </main>

            <!-- Detail Drawer (Desktop) -->
            <aside v-if="selectedItem && !previewItem" class="hidden xl:flex w-[380px] bg-white border-l border-slate-100 h-full p-10 overflow-y-auto custom-scroll flex-col page-enter z-30 shadow-2xl">
                <div class="flex justify-between items-center mb-10">
                    <h3 class="font-black text-slate-900 text-xl">詳細情報</h3>
                    <button @click="selectedItem = null" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-full text-slate-300 hover:text-slate-900 hover:bg-slate-100 transition-all">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="w-full aspect-[4/3] bg-slate-50 rounded-[2.5rem] mb-10 flex items-center justify-center overflow-hidden border border-slate-100 shadow-inner group">
                    <img v-if="isImage(selectedItem.type) && selectedItem.url" :src="selectedItem.url" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500">
                    <div v-else :class="['w-20 h-20 rounded-[1.8rem] flex items-center justify-center shadow-lg', getStyle(selectedItem.type).bg]">
                        <i :data-lucide="getStyle(selectedItem.type).icon" :class="['w-10 h-10', getStyle(selectedItem.type).text]"></i>
                    </div>
                </div>

                <div class="space-y-8 flex-1">
                    <div class="bg-slate-50 p-6 rounded-[1.6rem] border border-slate-100">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">File Name</label>
                        <p class="text-sm font-black text-slate-900 break-all leading-relaxed">{{ selectedItem.name }}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-slate-50 p-5 rounded-[1.6rem] border border-slate-100">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Format</label>
                            <p class="text-xs font-bold text-slate-700">{{ selectedItem.type.split('/')[1]?.toUpperCase() || 'UNKNOWN' }}</p>
                        </div>
                        <div class="bg-slate-50 p-5 rounded-[1.6rem] border border-slate-100">
                            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">Size</label>
                            <p class="text-xs font-bold text-slate-700">{{ formatSize(selectedItem.size) }}</p>
                        </div>
                    </div>
                </div>

                <div class="mt-10 grid grid-cols-2 gap-3">
                    <button v-if="selectedItem.url" @click="previewItem = selectedItem" class="bg-slate-950 text-white py-4 rounded-[1.2rem] font-bold flex items-center justify-center gap-2 btn-hover">
                        <i data-lucide="maximize-2" class="w-4 h-4"></i> 開く
                    </button>
                    <button v-if="selectedItem.url" @click="copyLink(selectedItem.url)" class="bg-white text-slate-700 py-4 rounded-[1.2rem] font-bold flex items-center justify-center gap-2 border border-slate-200 btn-hover">
                        <i data-lucide="link" class="w-4 h-4"></i> URL
                    </button>
                </div>
            </aside>

            <!-- Preview Overlay -->
            <div v-if="previewItem" class="fixed inset-0 z-[1000] dark-glass flex flex-col page-enter">
                <header class="h-24 px-6 lg:px-8 flex items-center justify-between text-white border-b border-white/5">
                    <div class="flex items-center gap-4 lg:gap-6 min-w-0">
                        <button @click="previewItem = null" class="w-10 h-10 lg:w-12 lg:h-12 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-full transition-all">
                            <i data-lucide="chevron-left" class="w-6 h-6 lg:w-7 lg:h-7"></i>
                        </button>
                        <div class="min-w-0">
                            <p class="font-black truncate max-w-[150px] sm:max-w-sm text-base lg:text-lg tracking-tight">{{ previewItem.name }}</p>
                            <p class="text-[9px] lg:text-[10px] font-bold text-white/40 uppercase tracking-widest">{{ formatSize(previewItem.size) }}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 lg:gap-3">
                        <button @click="toggleStar(previewItem)" class="p-3 lg:p-4 hover:bg-white/10 rounded-2xl transition-all">
                            <i data-lucide="star" :class="['w-5 h-5 lg:w-6 lg:h-6', previewItem.is_starred ? 'fill-amber-400 text-amber-400' : '']"></i>
                        </button>
                        <button v-if="previewItem.url" @click="downloadFile(previewItem)" class="p-3 lg:p-4 bg-white text-black rounded-2xl font-bold flex items-center gap-2 btn-hover text-sm lg:text-base">
                            <i data-lucide="download" class="w-4 h-4 lg:w-5 lg:h-5"></i> <span class="hidden sm:inline">保存</span>
                        </button>
                    </div>
                </header>
                <div class="flex-1 flex items-center justify-center p-6 lg:p-8">
                    <img v-if="isImage(previewItem.type) && previewItem.url" :src="previewItem.url" class="max-w-full max-h-full object-contain rounded-2xl lg:rounded-3xl shadow-[0_50px_100px_rgba(0,0,0,0.5)] animate-in zoom-in-95 duration-500">
                    <div v-else class="text-center">
                        <div :class="['w-24 h-24 lg:w-32 lg:h-32 rounded-[2.5rem] lg:rounded-[3rem] flex items-center justify-center mx-auto mb-8 lg:mb-10 shadow-2xl', getStyle(previewItem.type).bg]">
                            <i :data-lucide="getStyle(previewItem.type).icon" :class="['w-10 h-10 lg:w-14 lg:h-14', getStyle(previewItem.type).text]"></i>
                        </div>
                        <h2 class="text-2xl lg:text-3xl font-black text-white mb-4 px-4">{{ previewItem.name }}</h2>
                        <button @click="previewItem = null" class="px-10 lg:px-12 py-4 lg:py-5 bg-white/10 hover:bg-white/20 rounded-[1.6rem] font-bold text-white transition-all backdrop-blur-xl border border-white/10">閉じる</button>
                    </div>
                </div>
            </div>

            <!-- Context Menu -->
            <div v-if="contextMenu.show" :style="{ top: contextMenu.y + 'px', left: contextMenu.x + 'px' }" class="fixed z-[1100] w-64 lg:w-72 bg-white/95 backdrop-blur-2xl rounded-[2.2rem] shadow-[0_30px_60px_rgba(0,0,0,0.15)] border border-slate-100 p-2 lg:p-3 page-enter overflow-hidden">
                <div class="px-5 py-3 lg:py-4 border-b border-slate-100/50 mb-2">
                    <p class="text-[9px] lg:text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] truncate">{{ contextMenu.item.name }}</p>
                </div>
                <div class="space-y-0.5 lg:space-y-1">
                    <button @click="renameItem(contextMenu.item); closeContextMenu()" class="w-full flex items-center gap-4 px-5 py-3 text-[14px] font-bold text-slate-700 hover:bg-blue-50 hover:text-blue-600 rounded-2xl transition-all">
                        <i data-lucide="edit-3" class="w-4 h-4"></i> 名前を変更
                    </button>
                    <button @click="toggleStar(contextMenu.item); closeContextMenu()" class="w-full flex items-center gap-4 px-5 py-3 text-[14px] font-bold text-slate-700 hover:bg-amber-50 hover:text-amber-600 rounded-2xl transition-all">
                        <i data-lucide="star" :class="['w-4 h-4', contextMenu.item.is_starred ? 'fill-amber-500 text-amber-500' : '']"></i>
                        {{ contextMenu.item.is_starred ? 'お気に入り解除' : 'お気に入りに追加' }}
                    </button>
                    <button v-if="contextMenu.item.url" @click="copyLink(contextMenu.item.url); closeContextMenu()" class="w-full flex items-center gap-4 px-5 py-3 text-[14px] font-bold text-slate-700 hover:bg-slate-50 rounded-2xl transition-all">
                        <i data-lucide="link" class="w-4 h-4"></i> 共有リンクをコピー
                    </button>
                    <div class="h-px bg-slate-100 my-2 mx-3"></div>
                    <button v-if="!contextMenu.item.is_deleted" @click="moveToTrash(contextMenu.item.id); closeContextMenu()" class="w-full flex items-center gap-4 px-5 py-3 text-[14px] font-bold text-rose-500 hover:bg-rose-50 rounded-2xl transition-all">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> ゴミ箱へ移動
                    </button>
                    <button v-else @click="permanentlyDelete(contextMenu.item.id); closeContextMenu()" class="w-full flex items-center gap-4 px-5 py-3 text-[14px] font-bold text-rose-600 hover:bg-rose-50 rounded-2xl transition-all">
                        <i data-lucide="x-circle" class="w-4 h-4"></i> 完全に削除する
                    </button>
                </div>
            </div>
            <div v-if="contextMenu.show" @click="closeContextMenu" class="fixed inset-0 z-[1050]"></div>

            <!-- Global Notifications -->
            <transition name="fade">
                <div v-if="statusMessage" class="fixed top-10 left-1/2 -translate-x-1/2 dark-glass text-white px-6 lg:px-8 py-3 lg:py-4 rounded-[1.6rem] shadow-2xl z-[1500] flex items-center gap-4 border border-white/10">
                    <div class="loader scale-75 border-white/20 border-top-white"></div>
                    <span class="text-[10px] lg:text-xs font-black uppercase tracking-widest">{{ statusMessage }}</span>
                </div>
            </transition>

            <input type="file" ref="fileInput" class="hidden" @change="handleFileUpload" multiple>
        </template>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, updateDoc, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { createApp, ref, computed, onMounted, nextTick, watch } from "https://unpkg.com/vue@3/dist/vue.esm-browser.prod.js";

        const CLOUDINARY_CLOUD_NAME = "daiywtxmw";
        const CLOUDINARY_UPLOAD_PRESET = "noppo_preset";
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAwe9BsUFXA4MdzYYuekNsLo320MHqfXww",
            authDomain: "tribal-bonsai-470002-u0.firebaseapp.com",
            projectId: "tribal-bonsai-470002-u0",
            storageBucket: "tribal-bonsai-470002-u0.firebasestorage.app",
            appId: "1:189688737908:web:f3281eab70669b5796e121"
        };
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'noppo-drive-ultimate';
        const AUTH_WORKER_URL = "https://noppo-auth.noppo5319.workers.dev";

        createApp({
            setup() {
                const user = ref(null);
                const items = ref([]);
                const loading = ref(true);
                const currentTab = ref('all');
                const viewMode = ref('grid');
                const searchQuery = ref('');
                const selectedItem = ref(null);
                const previewItem = ref(null);
                const fileInput = ref(null);
                const statusMessage = ref("");
                const contextMenu = ref({ show: false, x: 0, y: 0, item: null });

                const navItems = [
                    { id: 'all', label: 'All Files', icon: 'layers' },
                    { id: 'starred', label: 'Starred', icon: 'star' },
                    { id: 'trash', label: 'Trash', icon: 'trash-2' }
                ];

                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);

                const storagePercent = computed(() => {
                    const total = items.value.filter(i => !i.is_deleted).reduce((acc, i) => acc + (i.size || 0), 0);
                    return Math.min(Math.round((total / (1024 * 1024 * 1024)) * 100), 100); 
                });
                
                const currentNavLabel = computed(() => navItems.find(n => n.id === currentTab.value)?.label || 'Files');
                
                const filteredItems = computed(() => {
                    let res = items.value;
                    if (currentTab.value === 'starred') res = res.filter(i => i.is_starred && !i.is_deleted);
                    else if (currentTab.value === 'trash') res = res.filter(i => i.is_deleted);
                    else res = res.filter(i => !i.is_deleted);

                    if (searchQuery.value) {
                        const q = searchQuery.value.toLowerCase();
                        res = res.filter(i => i.name.toLowerCase().includes(q));
                    }
                    return res;
                });

                watch([currentTab, filteredItems, previewItem, contextMenu, loading, viewMode, selectedItem], () => {
                    nextTick(() => lucide.createIcons());
                });

                onMounted(async () => {
                    const saved = localStorage.getItem('noppo_user');
                    if (saved) user.value = JSON.parse(saved);

                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) { console.error("Auth failed", e); }
                    };
                    initAuth();

                    onAuthStateChanged(auth, (u) => {
                        if (u) {
                            const itemsCollection = collection(db, 'artifacts', APP_ID, 'public', 'data', 'items');
                            onSnapshot(itemsCollection, (snap) => {
                                items.value = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                                                  .sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                                loading.value = false;
                            }, (err) => {
                                console.error("Firestore error:", err);
                                loading.value = false;
                            });
                        }
                    });
                });

                const handleFileUpload = async (e) => {
                    const files = Array.from(e.target.files);
                    for (const file of files) {
                        statusMessage.value = `UP: ${file.name}`;
                        try {
                            const docRef = await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'items'), {
                                name: file.name,
                                size: file.size,
                                type: file.type || 'application/octet-stream',
                                url: "",
                                is_deleted: false,
                                is_starred: false,
                                processing: true,
                                createdAt: serverTimestamp(),
                                ownerId: auth.currentUser?.uid
                            });

                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, {
                                method: 'POST', body: formData
                            });

                            const result = await res.json();
                            await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'items', docRef.id), {
                                url: result.secure_url,
                                processing: false
                            });
                            statusMessage.value = "COMPLETED";
                            setTimeout(() => statusMessage.value = "", 1500);
                        } catch (err) {
                            statusMessage.value = "ERROR";
                            setTimeout(() => statusMessage.value = "", 2000);
                        }
                    }
                };

                const moveToTrash = async (id) => {
                    const itemRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'items', id);
                    await updateDoc(itemRef, { is_deleted: true });
                };

                const permanentlyDelete = async (id) => {
                    const itemRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'items', id);
                    await deleteDoc(itemRef);
                    statusMessage.value = "DELETED";
                    setTimeout(() => statusMessage.value = "", 1500);
                    if (selectedItem.value?.id === id) selectedItem.value = null;
                };

                const renameItem = async (item) => {
                    const newName = prompt("新しい名前を入力してください:", item.name);
                    if (newName && newName !== item.name) {
                        await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'items', item.id), { name: newName });
                    }
                };

                const toggleStar = (item) => updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'items', item.id), { is_starred: !item.is_starred });
                const handleItemClick = (item) => {
                    // スマホではクリック即プレビュー、PCでは選択のみ
                    if (window.innerWidth < 1024) {
                        previewItem.value = item;
                    } else {
                        selectedItem.value = item;
                    }
                };
                const isImage = (t) => t?.startsWith('image/');
                const isSelected = (item) => selectedItem.value?.id === item.id;
                const showContextMenu = (e, item) => {
                    // タップ位置に基づいてメニュー表示
                    const x = Math.min(e.clientX, window.innerWidth - 280);
                    const y = Math.min(e.clientY, window.innerHeight - 350);
                    contextMenu.value = { show: true, x, y, item };
                };
                const closeContextMenu = () => contextMenu.value.show = false;
                const downloadFile = (item) => window.open(item.url, '_blank');
                const formatDate = (ts) => ts ? new Date(ts.seconds * 1000).toLocaleDateString() : '--';
                const formatSize = (b) => {
                    if (!b) return '0 B';
                    const s = Math.floor(Math.log(b) / Math.log(1024));
                    return (b / Math.pow(1024, s)).toFixed(1) + ' ' + ['B', 'KB', 'MB', 'GB'][s];
                };
                const copyLink = (url) => {
                    const el = document.createElement('textarea');
                    el.value = url; document.body.appendChild(el); el.select();
                    document.execCommand('copy'); document.body.removeChild(el);
                    statusMessage.value = "LINK COPIED";
                    setTimeout(() => statusMessage.value = "", 1500);
                };
                const getStyle = (t) => {
                    if (t?.includes('pdf')) return { bg: 'bg-rose-100', text: 'text-rose-600', icon: 'file-text' };
                    if (t?.includes('zip') || t?.includes('archive')) return { bg: 'bg-amber-100', text: 'text-amber-600', icon: 'archive' };
                    return { bg: 'bg-blue-100', text: 'text-blue-600', icon: 'file' };
                };

                return {
                    user, items, filteredItems, currentTab, viewMode, searchQuery, selectedItem, previewItem, loading,
                    statusMessage, fileInput, navItems, currentNavLabel, contextMenu, storagePercent,
                    login: () => window.location.href = `${AUTH_WORKER_URL}?redirect=${encodeURIComponent(window.location.href)}`,
                    logout: () => { localStorage.removeItem('noppo_user'); window.location.reload(); },
                    triggerUpload: () => fileInput.value.click(),
                    handleFileUpload, handleItemClick, isSelected, showContextMenu, closeContextMenu,
                    toggleStar, moveToTrash, isImage, getStyle, formatSize, downloadFile, formatDate,
                    copyLink, renameItem, permanentlyDelete
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
